---
# Grafana ConfigMap with datasources
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: monitoring
  labels:
    app: grafana
data:
  prometheus.yaml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus:9090
        isDefault: true
        editable: true
        jsonData:
          timeInterval: "15s"
          queryTimeout: "60s"

---
# Grafana ConfigMap with dashboard providers
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-provider
  namespace: monitoring
  labels:
    app: grafana
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
      - name: 'Traveease Dashboards'
        orgId: 1
        folder: 'Traveease'
        type: file
        disableDeletion: false
        updateIntervalSeconds: 10
        allowUiUpdates: true
        options:
          path: /var/lib/grafana/dashboards

---
# Grafana Dashboard ConfigMap - API Metrics
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-api-metrics
  namespace: monitoring
  labels:
    app: grafana
    grafana_dashboard: "true"
data:
  api-metrics.json: |
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": "-- Grafana --",
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "editable": true,
      "gnetId": null,
      "graphTooltip": 0,
      "id": null,
      "links": [],
      "panels": [
        {
          "datasource": "Prometheus",
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"tooltip": false, "viz": false, "legend": false}, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]}
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
          "id": 2,
          "options": {"legend": {"calcs": [], "displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "single"}},
          "targets": [
            {
              "expr": "rate(http_requests_total[5m])",
              "legendFormat": "{{job}}: {{method}} {{path}}",
              "refId": "A"
            }
          ],
          "title": "Request Rate (5m avg)",
          "type": "timeseries"
        },
        {
          "datasource": "Prometheus",
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 100}, {"color": "red", "value": 500}]}
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
          "id": 3,
          "options": {"colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "text": {}, "textMode": "auto"},
          "pluginVersion": "8.0.0",
          "targets": [
            {
              "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
              "legendFormat": "p95 {{job}}",
              "refId": "A"
            }
          ],
          "title": "P95 Latency (ms)",
          "type": "stat"
        },
        {
          "datasource": "Prometheus",
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"tooltip": false, "viz": false, "legend": false}, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]}
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
          "id": 4,
          "options": {"legend": {"calcs": [], "displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "single"}},
          "targets": [
            {
              "expr": "rate(http_requests_total{status=~\"5..\"}[5m])",
              "legendFormat": "{{job}}: {{status}}",
              "refId": "A"
            }
          ],
          "title": "Error Rate (5xx)",
          "type": "timeseries"
        },
        {
          "datasource": "Prometheus",
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [],
              "thresholds": {"mode": "percentage", "steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 50}, {"color": "red", "value": 80}]}
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
          "id": 5,
          "options": {"orientation": "auto", "showThresholdLabels": false, "showThresholdMarkers": true},
          "pluginVersion": "8.0.0",
          "targets": [
            {
              "expr": "(sum(rate(http_requests_total{status=~\"5..\"}[5m])) by (job)) / (sum(rate(http_requests_total[5m])) by (job))",
              "legendFormat": "{{job}}",
              "refId": "A"
            }
          ],
          "title": "Error Rate %",
          "type": "gauge"
        }
      ],
      "refresh": "10s",
      "schemaVersion": 27,
      "style": "dark",
      "tags": ["traveease", "api"],
      "templating": {"list": []},
      "time": {"from": "now-1h", "to": "now"},
      "timepicker": {},
      "timezone": "",
      "title": "API Metrics",
      "uid": "api-metrics",
      "version": 1
    }

---
# Grafana Dashboard ConfigMap - Infrastructure
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-infrastructure
  namespace: monitoring
  labels:
    app: grafana
    grafana_dashboard: "true"
data:
  infrastructure.json: |
    {
      "annotations": {"list": []},
      "editable": true,
      "gnetId": null,
      "graphTooltip": 0,
      "id": null,
      "links": [],
      "panels": [
        {
          "datasource": "Prometheus",
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"tooltip": false, "viz": false, "legend": false}, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]}
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
          "id": 2,
          "options": {"legend": {"calcs": [], "displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "single"}},
          "targets": [
            {
              "expr": "100 - (avg by (instance) (rate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)",
              "legendFormat": "{{instance}}",
              "refId": "A"
            }
          ],
          "title": "CPU Usage %",
          "type": "timeseries"
        },
        {
          "datasource": "Prometheus",
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"tooltip": false, "viz": false, "legend": false}, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]}
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
          "id": 3,
          "options": {"legend": {"calcs": [], "displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "single"}},
          "targets": [
            {
              "expr": "(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100",
              "legendFormat": "{{instance}}",
              "refId": "A"
            }
          ],
          "title": "Memory Usage %",
          "type": "timeseries"
        },
        {
          "datasource": "Prometheus",
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"tooltip": false, "viz": false, "legend": false}, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]}
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
          "id": 4,
          "options": {"legend": {"calcs": [], "displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "single"}},
          "targets": [
            {
              "expr": "rate(node_network_receive_bytes_total[5m])",
              "legendFormat": "RX {{device}} {{instance}}",
              "refId": "A"
            },
            {
              "expr": "rate(node_network_transmit_bytes_total[5m])",
              "legendFormat": "TX {{device}} {{instance}}",
              "refId": "B"
            }
          ],
          "title": "Network I/O",
          "type": "timeseries"
        },
        {
          "datasource": "Prometheus",
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"tooltip": false, "viz": false, "legend": false}, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]}
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
          "id": 5,
          "options": {"legend": {"calcs": [], "displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "single"}},
          "targets": [
            {
              "expr": "rate(node_disk_io_time_seconds_total[5m])",
              "legendFormat": "{{device}} {{instance}}",
              "refId": "A"
            }
          ],
          "title": "Disk I/O Time",
          "type": "timeseries"
        }
      ],
      "refresh": "10s",
      "schemaVersion": 27,
      "style": "dark",
      "tags": ["traveease", "infrastructure"],
      "templating": {"list": []},
      "time": {"from": "now-1h", "to": "now"},
      "timepicker": {},
      "timezone": "",
      "title": "Infrastructure Metrics",
      "uid": "infrastructure",
      "version": 1
    }

---
# Grafana Dashboard ConfigMap - SLA Tracking
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-sla
  namespace: monitoring
  labels:
    app: grafana
    grafana_dashboard: "true"
data:
  sla-tracking.json: |
    {
      "annotations": {"list": []},
      "editable": true,
      "gnetId": null,
      "graphTooltip": 0,
      "id": null,
      "links": [],
      "panels": [
        {
          "datasource": "Prometheus",
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "red", "value": null}, {"color": "yellow", "value": 95}, {"color": "green", "value": 99}]},
              "unit": "percent"
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
          "id": 2,
          "options": {"colorMode": "background", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "text": {}, "textMode": "auto"},
          "pluginVersion": "8.0.0",
          "targets": [
            {
              "expr": "(sum(rate(http_requests_total{status=~\"[^5]\"}[30d])) by (job)) / (sum(rate(http_requests_total[30d])) by (job)) * 100",
              "legendFormat": "{{job}} Uptime",
              "refId": "A"
            }
          ],
          "title": "30-Day Uptime %",
          "type": "stat"
        },
        {
          "datasource": "Prometheus",
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 15}, {"color": "red", "value": 30}]},
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
          "id": 3,
          "options": {"colorMode": "background", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "text": {}, "textMode": "auto"},
          "pluginVersion": "8.0.0",
          "targets": [
            {
              "expr": "histogram_quantile(0.95, rate(payment_processing_duration_seconds_bucket[7d]))",
              "legendFormat": "Payment p95 (SLA: <15s)",
              "refId": "A"
            }
          ],
          "title": "Payment Processing p95",
          "type": "stat"
        },
        {
          "datasource": "Prometheus",
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 30}, {"color": "red", "value": 60}]},
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
          "id": 4,
          "options": {"colorMode": "background", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "text": {}, "textMode": "auto"},
          "pluginVersion": "8.0.0",
          "targets": [
            {
              "expr": "histogram_quantile(0.95, rate(booking_confirmation_duration_seconds_bucket[7d]))",
              "legendFormat": "Booking p95 (SLA: <30s)",
              "refId": "A"
            }
          ],
          "title": "Booking Confirmation p95",
          "type": "stat"
        },
        {
          "datasource": "Prometheus",
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 0.05}, {"color": "red", "value": 0.1}]},
              "unit": "percentunit"
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
          "id": 5,
          "options": {"colorMode": "background", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "text": {}, "textMode": "auto"},
          "pluginVersion": "8.0.0",
          "targets": [
            {
              "expr": "(sum(rate(http_requests_total{status=~\"5..\"}[7d])) by (job)) / (sum(rate(http_requests_total[7d])) by (job))",
              "legendFormat": "{{job}} Error Rate (SLA: <0.1%)",
              "refId": "A"
            }
          ],
          "title": "7-Day Error Rate",
          "type": "stat"
        }
      ],
      "refresh": "10s",
      "schemaVersion": 27,
      "style": "dark",
      "tags": ["traveease", "sla"],
      "templating": {"list": []},
      "time": {"from": "now-30d", "to": "now"},
      "timepicker": {},
      "timezone": "",
      "title": "SLA Tracking",
      "uid": "sla-tracking",
      "version": 1
    }

---
# Grafana Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: grafana
  namespace: monitoring

---
# Grafana Secret for admin password
apiVersion: v1
kind: Secret
metadata:
  name: grafana-admin
  namespace: monitoring
  labels:
    app: grafana
type: Opaque
stringData:
  admin-user: admin
  admin-password: "changeme"  # Change this in production!

---
# Grafana Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app: grafana
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "3000"
    spec:
      serviceAccountName: grafana
      securityContext:
        runAsNonRoot: true
        runAsUser: 472
        fsGroup: 472
      
      containers:
      - name: grafana
        image: grafana/grafana:latest
        imagePullPolicy: IfNotPresent
        ports:
        - name: http
          containerPort: 3000
          protocol: TCP
        
        env:
        - name: GF_SECURITY_ADMIN_USER
          valueFrom:
            secretKeyRef:
              name: grafana-admin
              key: admin-user
        - name: GF_SECURITY_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: grafana-admin
              key: admin-password
        - name: GF_INSTALL_PLUGINS
          value: "grafana-worldmap-panel,grafana-piechart-panel"
        - name: GF_USERS_ALLOW_SIGN_UP
          value: "false"
        
        volumeMounts:
        - name: datasources
          mountPath: /etc/grafana/provisioning/datasources
        - name: dashboard-provider
          mountPath: /etc/grafana/provisioning/dashboards
        - name: dashboards
          mountPath: /var/lib/grafana/dashboards
        - name: storage
          mountPath: /var/lib/grafana
        
        resources:
          requests:
            cpu: 250m
            memory: 512Mi
          limits:
            cpu: 500m
            memory: 1Gi
        
        livenessProbe:
          httpGet:
            path: /api/health
            port: http
          initialDelaySeconds: 30
          periodSeconds: 15
          timeoutSeconds: 10
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /api/health
            port: http
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 5
          failureThreshold: 3
      
      volumes:
      - name: datasources
        configMap:
          name: grafana-datasources
      - name: dashboard-provider
        configMap:
          name: grafana-dashboard-provider
      - name: dashboards
        emptyDir: {}
      - name: storage
        emptyDir:
          sizeLimit: 5Gi

---
# Grafana Service
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app: grafana
spec:
  type: LoadBalancer
  ports:
  - name: http
    port: 80
    targetPort: http
    protocol: TCP
  selector:
    app: grafana
